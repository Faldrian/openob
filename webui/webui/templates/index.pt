<!DOCTYPE html>
<html lang="en">
  <head>
    <title>OpenOB WebUI</title>
    <link rel="stylesheet" href="${request.static_url('webui:static/global.css')}" type="text/css" media="screen" charset="utf-8" />
    <script language="javascript" type="text/javascript" src="${request.static_url('webui:static/jquery-1.7.1.min.js')}"></script>
    <script language="javascript" type="text/javascript" src="${request.static_url('webui:static/jquery.sparkline.min.js')}"></script>
  </head>
  <body>
    <div id="container">
      <div id="header">
        <a href="/">OpenOB</a>
      </div>
      <div id="content">
        <div id="status">
          <h1>Link Status</h1>
          <h3>Transmitter</h3>
          <div id="tx_meters" class="meterbridge">
            <div class="meter">
              RMS L <div class="meter_value" id="tx_rms_left_meter"></div><span class="spark" id="tx_rms_left"></span>
            </div>
            <div class="meter">
              RMS R <div class="meter_value" id="tx_rms_right_meter"></div><span class="spark" id="tx_rms_right"></span>
            </div>
            <div class="meter">
              Peak L <div class="meter_value" id="tx_peak_left_meter"></div><span class="spark" id="tx_peak_left"></span>
            </div>
            <div class="meter">
              Peak R <div class="meter_value" id="tx_peak_right_meter"></div><span class="spark" id="tx_peak_right"></span>
            </div>
          </div>
          <div id="tx_not_running" class="meterhidden">
            <p>Transmitter not active - run <code>python tx.py</code> to enable this node's transmitter</p>
          </div>
          <h3>Receiver</h3>
          <div id="rx_meters" class="meterbridge">
            <div class="meter">
              RMS L <div class="meter_value" id="rx_rms_left_meter"></div><span class="spark" id="rx_rms_left"></span>
            </div>
            <div class="meter">
              RMS R <div class="meter_value" id="rx_rms_right_meter"></div><span class="spark" id="rx_rms_right"></span>
            </div>
            <div class="meter">
              Peak L <div class="meter_value" id="rx_peak_left_meter"></div><span class="spark" id="rx_peak_left"></span>
            </div>
            <div class="meter">
              Peak R <div class="meter_value" id="rx_peak_right_meter"></div><span class="spark" id="rx_peak_right"></span>
            </div>
          </div>
          <div id="rx_not_running" class="meterhidden">
            <p>Receiver not active - run <code>python rx.py</code> to enable this node's receiver</p>
          </div>
        </div>
        <div id="tx-params">
          <h1>Transmission Parameters</h1>
          <div class="parameter">
            <a href="/edit/tx/receiver_address">Receiver Address</a>
            <strong>${static_conf['tx']['receiver_address']}</strong>
            <p class="help">The address this system will be transmitting to, either an IP address or a hostname.</p>
          </div>
          <div class="parameter">
            <a href="/edit/tx/configuration_name">Link Name</a>
            <strong>${static_conf['tx']['configuration_name']}</strong>
            <p class="help">The name of the link configuration. Identifies this link configuration on the configuration server. Must be configured identially at each end of the link.</p>
          </div>
          <div class="parameter">
            <a href="/edit/tx/audio_connection">Audio Source</a>
            <strong>${static_conf['tx']['audio_connection']}</strong>
            <p class="help">The audio source, either ALSA or JACK.</p>
          </div>
          <div class="parameter">
            <a href="/edit/tx/alsa_device">ALSA Device</a>
            <strong>${static_conf['tx']['alsa_device']}</strong>
            <p class="help">If ALSA is used above, this is the sound card the ALSA client will be connected to.</p>
          </div>
          <div class="parameter">
            <a href="/edit/tx/bitrate">Encoder Bitrate</a>
            <strong>${static_conf['tx']['bitrate']} bit/s</strong>
            <p class="help">The bitrate of the encoder used in the link, if one is used. Not used in Linear PCM mode.</p>
          </div>
          <div class="parameter">
            <a href="/edit/tx/base_port">Base Port</a>
            <strong>${static_conf['tx']['base_port']}</strong>
            <p class="help">The base port used in this link. With the current setting, ports ${static_conf['tx']['base_port']} (UDP) and ${int(static_conf['tx']['base_port'])+1} (UDP) must both be open on the receiver.</p>
          </div>
          <div class="parameter">
            <a href="#">Link Mode</a>
            <strong>${static_conf['tx']['encoder']['tx']} -> ${static_conf['tx']['payloader']['tx']} - > NETWORK - > ${static_conf['tx']['payloader']['rx']} -> ${static_conf['tx']['encoder']['rx']}</strong>
            <p class="help">The link mode sets the encoder, payloader, depayloader and decoders used in the link.</p>
          </div>
        </div>
        <div id="rx-params">
          <h1>Receiver Parameters</h1>
          <div class="parameter">
            <a href="#">Link Name</a>
            <strong>${static_conf['rx']['configuration_name']}</strong>
            <p class="help">The name of the link configuration to receive. Must be set to the same value as the transmitter you want to receive, which must be configured to send to this system's IP address.</p>
          </div>
          <div class="parameter">
            <a href="/edit/rx/audio_connection">Audio Output</a>
            <strong>${static_conf['rx']['audio_connection']}</strong>
            <p class="help">The audio output mode, either ALSA or JACK.</p>
          </div>
          <div class="parameter">
            <a href="/edit/rx/alsa_device">ALSA Device</a>
            <strong>${static_conf['rx']['alsa_device']}</strong>
            <p class="help">If ALSA is used above, this is the sound card the ALSA client will be connected to.</p>
          </div>
        </div>
      </div>
    </div>
    <div id="footer">
      <a href="https://github.com/JamesHarrison/openob">Open Outside Broadcast</a> - Web Interface - BETA
    </div>
    <script type="text/javascript">
      $(function () {
        function update() {
          var now = (new Date().getTime() / 1000)-3;
          $.get("/tx_levels.json",function(data){
            if (now < data['timestamp']) {
              $('#tx_meters').show();
              $('#tx_not_running').hide();
              var opts = {'type':'bar', 'barWidth':1, 'height':'90px', 'chartRangeMin':-40.0, 'chartRangeMax':0.0, 'negBarColor':'#6eaede'};
              $('#tx_rms_left').sparkline(data['rms_left'],opts);
              $('#tx_rms_right').sparkline(data['rms_right'],opts);
              $('#tx_peak_left').sparkline(data['peak_left'],opts);
              $('#tx_peak_right').sparkline(data['peak_right'],opts);
              $('#tx_rms_left_meter').text(Math.round(data['rms_left'][0]*10)/10);
              $('#tx_rms_right_meter').text(Math.round(data['rms_right'][0]*10)/10);
              $('#tx_peak_left_meter').text(Math.round(data['peak_left'][0]*10)/10);
              $('#tx_peak_right_meter').text(Math.round(data['peak_right'][0]*10)/10);
            } else {
              $('#tx_meters').hide();
              $('#tx_not_running').show();
            }
          }, "json");
          $.get("/rx_levels.json",function(data){
            if (now < data['timestamp']) {
              $('#rx_meters').show();
              $('#rx_not_running').hide();
              var opts = {'type':'bar', 'barWidth':1, 'height':'90px', 'chartRangeMin':-40.0, 'chartRangeMax':0.0, 'negBarColor':'#6eaede'};
              $('#rx_rms_left').sparkline(data['rms_left'],opts);
              $('#rx_rms_right').sparkline(data['rms_right'],opts);
              $('#rx_peak_left').sparkline(data['peak_left'],opts);
              $('#rx_peak_right').sparkline(data['peak_right'],opts);
              $('#rx_rms_left_meter').text(Math.round(data['rms_left'][0]*10)/10);
              $('#rx_rms_right_meter').text(Math.round(data['rms_right'][0]*10)/10);
              $('#rx_peak_left_meter').text(Math.round(data['peak_left'][0]*10)/10);
              $('#rx_peak_right_meter').text(Math.round(data['peak_right'][0]*10)/10);
            } else {
              $('#rx_meters').hide();
              $('#rx_not_running').show();
            }
          }, "json");
          
          setTimeout(update, 1000);
        }

        update();
      });
    </script>
  </body>
</html>
